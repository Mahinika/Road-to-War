<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animation Editor - Road of War</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
        }

        .header {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        h1 {
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        button:hover {
            background: #45a049;
        }

        button.secondary {
            background: #2196F3;
        }

        button.secondary:hover {
            background: #1976D2;
        }

        button.danger {
            background: #f44336;
        }

        button.danger:hover {
            background: #da190b;
        }

        select, input {
            background: #333;
            color: #e0e0e0;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
        }

        .main-container {
            display: grid;
            grid-template-columns: 300px 1fr 400px;
            gap: 20px;
        }

        .sidebar {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            height: fit-content;
        }

        .sidebar h2 {
            color: #4CAF50;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .editor-area {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
        }

        .preview-area {
            background: #1a1a1a;
            border: 2px solid #555;
            border-radius: 8px;
            padding: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            margin-bottom: 20px;
        }

        .preview-canvas {
            image-rendering: pixelated;
            max-width: 100%;
        }

        .keyframe-editor {
            background: #333;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .keyframe-item {
            background: #2a2a2a;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #555;
        }

        .keyframe-item.selected {
            border-color: #4CAF50;
            background: #2a4a2a;
        }

        .keyframe-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .keyframe-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-size: 12px;
            color: #bbb;
        }

        .control-group input {
            width: 100%;
        }

        .properties-panel {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            height: fit-content;
        }

        .property-group {
            margin-bottom: 20px;
        }

        .property-group h3 {
            color: #4CAF50;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .property-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #444;
        }

        .property-item:last-child {
            border-bottom: none;
        }

        .property-label {
            color: #bbb;
            font-size: 14px;
        }

        .property-value {
            color: #e0e0e0;
            font-size: 14px;
        }

        .connection-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .connection-status.connected {
            background: #4CAF50;
        }

        .connection-status.disconnected {
            background: #f44336;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸŽ¨ Animation Editor</h1>
        <div>
            <span class="connection-status" id="connectionStatus"></span>
            <span id="connectionText">Connecting to game...</span>
        </div>
        <div class="controls">
            <button id="newBtn" class="secondary">New Animation</button>
            <button id="loadBtn" class="secondary">Load Animation</button>
            <button id="saveBtn">Save</button>
            <button id="exportBtn">Export Config</button>
            <button id="previewBtn">Preview</button>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <h2>Animation List</h2>
            <div id="animationList">
                <div style="color: #666; text-align: center; padding: 20px;">
                    Loading animations...
                </div>
            </div>
        </div>

        <div class="editor-area">
            <div class="preview-area">
                <canvas id="previewCanvas" class="preview-canvas" width="192" height="192"></canvas>
            </div>

            <div class="keyframe-editor">
                <h2>Keyframes</h2>
                <div id="keyframeList">
                    <div style="color: #666; text-align: center; padding: 20px;">
                        No animation selected
                    </div>
                </div>
            </div>
        </div>

        <div class="properties-panel">
            <h2>Properties</h2>
            <div id="propertiesContent">
                <div style="color: #666; text-align: center; padding: 20px;">
                    Select a keyframe to edit
                </div>
            </div>
        </div>
    </div>

    <script>
        let gameScene = null;
        let currentAnimation = null;
        let currentKeyframes = [];
        let selectedKeyframeIndex = -1;

        // Check connection
        function checkConnection() {
            let scene = null;
            
            if (window.game && window.gameScene) {
                scene = window.gameScene;
            } else if (window.game && window.game.scene) {
                scene = window.game.scene.getScene('GameScene');
                if (scene) window.gameScene = scene;
            } else if (window.parent && window.parent !== window) {
                if (window.parent.game && window.parent.gameScene) {
                    scene = window.parent.gameScene;
                } else if (window.parent.game && window.parent.game.scene) {
                    scene = window.parent.game.scene.getScene('GameScene');
                }
            }
            
            if (scene && scene.animationManager) {
                gameScene = scene;
                document.getElementById('connectionStatus').className = 'connection-status connected';
                document.getElementById('connectionText').textContent = 'Connected to game';
                loadAnimations();
                return true;
            } else {
                document.getElementById('connectionStatus').className = 'connection-status disconnected';
                document.getElementById('connectionText').textContent = 'Not connected - Make sure game is running and GameScene is loaded';
                return false;
            }
        }

        // Load animations
        function loadAnimations() {
            if (!gameScene || !gameScene.anims) return;

            const list = document.getElementById('animationList');
            const animations = [];

            for (const key of Object.keys(gameScene.anims.anims.entries)) {
                const anim = gameScene.anims.get(key);
                animations.push({
                    key,
                    frameCount: anim.frames ? anim.frames.length : 0,
                    frameRate: anim.frameRate || 12
                });
            }

            list.innerHTML = '';
            if (animations.length === 0) {
                list.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No animations found</div>';
                return;
            }

            for (const anim of animations.sort((a, b) => a.key.localeCompare(b.key))) {
                const item = document.createElement('div');
                item.className = 'keyframe-item';
                item.style.cursor = 'pointer';
                item.onclick = () => loadAnimation(anim.key);
                item.innerHTML = `
                    <div class="keyframe-header">
                        <strong style="color: #4CAF50;">${anim.key}</strong>
                    </div>
                    <div style="font-size: 12px; color: #bbb;">
                        ${anim.frameCount} frames @ ${anim.frameRate} fps
                    </div>
                `;
                list.appendChild(item);
            }
        }

        // Load animation
        function loadAnimation(animKey) {
            if (!gameScene || !gameScene.anims || !gameScene.anims.exists(animKey)) {
                return;
            }

            currentAnimation = animKey;
            const anim = gameScene.anims.get(animKey);

            // Try to load keyframes from config
            loadKeyframesFromConfig(animKey);

            // Update UI
            document.querySelectorAll('.keyframe-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            renderKeyframes();
        }

        // Load keyframes from config
        function loadKeyframesFromConfig(animKey) {
            // Extract animation name from key (e.g., "paladin-shared-walk" -> "walk")
            const parts = animKey.split('-');
            const animName = parts[parts.length - 1];

            // Try to load from keyframe configs
            if (gameScene.cache && gameScene.cache.json.exists('keyframe-configs')) {
                const configs = gameScene.cache.json.get('keyframe-configs');
                const config = configs[animName];

                if (config) {
                    // Generate keyframes from config
                    const frameCount = gameScene.anims.get(animKey).frames.length;
                    currentKeyframes = generateKeyframesFromConfig(animName, frameCount, config);
                    return;
                }
            }

            // Fallback: create default keyframes
            const frameCount = gameScene.anims.get(animKey).frames.length;
            currentKeyframes = [];
            for (let i = 0; i < frameCount; i++) {
                currentKeyframes.push({
                    index: i,
                    x: 0,
                    y: 0,
                    rotation: 0,
                    scale: { x: 1, y: 1 },
                    components: {}
                });
            }
        }

        // Generate keyframes from config
        function generateKeyframesFromConfig(animName, frameCount, config) {
            const keyframes = [];
            const params = config.parameters || {};

            for (let i = 0; i < frameCount; i++) {
                const t = i / frameCount;
                let keyframe = { index: i, x: 0, y: 0, rotation: 0, scale: { x: 1, y: 1 }, components: {} };

                switch (config.type) {
                    case 'breathing':
                        keyframe.y = Math.sin(t * Math.PI * 2) * (params.yOffsetAmplitude || 1);
                        break;
                    case 'walkCycle':
                        keyframe.y = Math.sin(t * Math.PI * 2) * (params.yOffsetAmplitude || 2);
                        keyframe.x = Math.sin(t * Math.PI * 2) * (params.xOffsetAmplitude || 1);
                        // Add component transforms...
                        break;
                    case 'phased':
                        const forward = t < 0.3 ? t / 0.3 : (t < 0.7 ? 1 : (1 - (t - 0.7) / 0.3));
                        keyframe.x = forward * (params.forwardLean || 3);
                        keyframe.rotation = forward * (params.rotationAmplitude || 0.1);
                        break;
                }

                keyframes.push(keyframe);
            }

            return keyframes;
        }

        // Render keyframes
        function renderKeyframes() {
            const container = document.getElementById('keyframeList');
            container.innerHTML = '';

            if (currentKeyframes.length === 0) {
                container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No keyframes</div>';
                return;
            }

            for (const keyframe of currentKeyframes) {
                const item = document.createElement('div');
                item.className = 'keyframe-item' + (keyframe.index === selectedKeyframeIndex ? ' selected' : '');
                item.onclick = () => selectKeyframe(keyframe.index);
                item.innerHTML = `
                    <div class="keyframe-header">
                        <strong style="color: #4CAF50;">Frame ${keyframe.index}</strong>
                    </div>
                    <div style="font-size: 12px; color: #bbb;">
                        X: ${keyframe.x.toFixed(2)}, Y: ${keyframe.y.toFixed(2)}, Rot: ${(keyframe.rotation * 180 / Math.PI).toFixed(1)}Â°
                    </div>
                `;
                container.appendChild(item);
            }
        }

        // Select keyframe
        function selectKeyframe(index) {
            selectedKeyframeIndex = index;
            renderKeyframes();
            showKeyframeProperties(currentKeyframes[index]);
        }

        // Show keyframe properties
        function showKeyframeProperties(keyframe) {
            const container = document.getElementById('propertiesContent');
            container.innerHTML = `
                <div class="property-group">
                    <h3>Transform</h3>
                    <div class="property-item">
                        <span class="property-label">X Offset:</span>
                        <input type="number" id="propX" value="${keyframe.x}" step="0.1" style="width: 100px;">
                    </div>
                    <div class="property-item">
                        <span class="property-label">Y Offset:</span>
                        <input type="number" id="propY" value="${keyframe.y}" step="0.1" style="width: 100px;">
                    </div>
                    <div class="property-item">
                        <span class="property-label">Rotation:</span>
                        <input type="number" id="propRotation" value="${(keyframe.rotation * 180 / Math.PI).toFixed(2)}" step="1" style="width: 100px;">
                    </div>
                    <div class="property-item">
                        <span class="property-label">Scale X:</span>
                        <input type="number" id="propScaleX" value="${keyframe.scale.x}" step="0.1" style="width: 100px;">
                    </div>
                    <div class="property-item">
                        <span class="property-label">Scale Y:</span>
                        <input type="number" id="propScaleY" value="${keyframe.scale.y}" step="0.1" style="width: 100px;">
                    </div>
                </div>
                <button onclick="updateKeyframe()" style="width: 100%; margin-top: 10px;">Update Keyframe</button>
            `;

            // Add event listeners
            document.getElementById('propX').onchange = updateKeyframe;
            document.getElementById('propY').onchange = updateKeyframe;
            document.getElementById('propRotation').onchange = updateKeyframe;
            document.getElementById('propScaleX').onchange = updateKeyframe;
            document.getElementById('propScaleY').onchange = updateKeyframe;
        }

        // Update keyframe
        function updateKeyframe() {
            if (selectedKeyframeIndex < 0 || selectedKeyframeIndex >= currentKeyframes.length) return;

            const keyframe = currentKeyframes[selectedKeyframeIndex];
            keyframe.x = parseFloat(document.getElementById('propX').value) || 0;
            keyframe.y = parseFloat(document.getElementById('propY').value) || 0;
            keyframe.rotation = (parseFloat(document.getElementById('propRotation').value) || 0) * Math.PI / 180;
            keyframe.scale.x = parseFloat(document.getElementById('propScaleX').value) || 1;
            keyframe.scale.y = parseFloat(document.getElementById('propScaleY').value) || 1;

            renderKeyframes();
            showKeyframeProperties(keyframe);
        }

        // Export config
        function exportConfig() {
            if (!currentAnimation || currentKeyframes.length === 0) {
                alert('No animation loaded');
                return;
            }

            const parts = currentAnimation.split('-');
            const animName = parts[parts.length - 1];

            const config = {
                type: 'custom',
                description: `Custom animation: ${animName}`,
                parameters: {},
                keyframes: currentKeyframes.map(kf => ({
                    x: kf.x,
                    y: kf.y,
                    rotation: kf.rotation,
                    scale: kf.scale
                }))
            };

            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `animation-${animName}-config.json`;
            a.click();
        }

        // Event listeners
        document.getElementById('exportBtn').onclick = exportConfig;
        document.getElementById('previewBtn').onclick = () => {
            if (currentAnimation) {
                window.open(`animation-preview.html?anim=${encodeURIComponent(currentAnimation)}`, '_blank');
            }
        };

        // Initialize
        checkConnection();
        setInterval(checkConnection, 2000);
    </script>
</body>
</html>

