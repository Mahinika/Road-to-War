<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Inject Debugger</title>
    <script>
        // This page will try to inject the debugger into the game window
        // It should be opened from the game tab using: window.open('/inject-debugger.html')
        
        window.onload = function() {
            // Try to access the opener (game window)
            if (window.opener && window.opener.gameScene) {
                injectDebugger(window.opener);
                document.body.innerHTML = '<h1 style="color:green;">‚úÖ Debugger injected successfully!<br>Check the game window.</h1>';
            } else {
                document.body.innerHTML = '<h1 style="color:red;">‚ùå Cannot access game window.<br><br>To use this:<br>1. In the game tab, open console (F12)<br>2. Run: window.open("/inject-debugger.html")<br>3. Or use the injection script directly</h1>';
            }
        };
        
        function injectDebugger(targetWindow) {
            const script = targetWindow.document.createElement('script');
            script.textContent = getInjectionScript();
            targetWindow.document.body.appendChild(script);
        }
        
        function getInjectionScript() {
            return `(function() {
    if (!window.gameScene) {
        console.error('Game scene not found!');
        return;
    }
    
    const existing = document.getElementById('hero-debugger-panel');
    if (existing) {
        existing.remove();
        return;
    }
    
    const panel = document.createElement('div');
    panel.id = 'hero-debugger-panel';
    panel.style.cssText = 'position:fixed;top:10px;right:10px;background:#1e293b;color:white;padding:20px;border:2px solid #3b82f6;border-radius:8px;z-index:10000;max-width:500px;max-height:90vh;overflow-y:auto;font-family:system-ui;box-shadow:0 4px 6px rgba(0,0,0,0.3);';
    
    const header = document.createElement('h3');
    header.textContent = 'üéÆ Hero Visibility Debugger';
    header.style.marginTop = '0';
    panel.appendChild(header);
    
    const closeBtn = document.createElement('button');
    closeBtn.textContent = '‚úï Close';
    closeBtn.style.cssText = 'position:absolute;top:10px;right:10px;background:#ef4444;padding:5px 10px;border:none;color:white;border-radius:3px;cursor:pointer;';
    closeBtn.onclick = () => panel.remove();
    panel.appendChild(closeBtn);
    
    const results = document.createElement('div');
    results.id = 'debug-results';
    results.style.cssText = 'margin:10px 0;padding:10px;background:#0f172a;border-radius:5px;min-height:100px;';
    panel.appendChild(results);
    
    function updateResults(html) {
        results.innerHTML = html;
    }
    
    const diagnosticBtn = document.createElement('button');
    diagnosticBtn.textContent = 'üîç Run Diagnostic';
    diagnosticBtn.style.cssText = 'background:#3b82f6;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;margin:5px;display:block;width:100%;';
    diagnosticBtn.onclick = () => {
        const scene = window.gameScene;
        if (!scene) {
            updateResults('<p style="color:#ef4444;">Game scene not found!</p>');
            return;
        }
        
        const checks = [];
        const heroCount = scene.partyMemberSprites?.length || 0;
        checks.push({name: 'Hero Count', status: heroCount === 5 ? 'pass' : 'fail', message: \`Found \${heroCount} heroes (expected 5)\`});
        
        let visibleCount = 0;
        scene.partyMemberSprites?.forEach((pm) => {
            if (pm.sprite && pm.sprite.visible && pm.sprite.active) visibleCount++;
        });
        checks.push({name: 'Visibility', status: visibleCount === 5 ? 'pass' : 'fail', message: \`\${visibleCount}/5 heroes visible and active\`});
        
        const camera = scene.cameras?.main;
        if (camera) {
            checks.push({name: 'Camera', status: 'pass', message: \`At (\${camera.scrollX.toFixed(0)}, \${camera.scrollY.toFixed(0)})\`});
        } else {
            checks.push({name: 'Camera', status: 'fail', message: 'Camera not found'});
        }
        
        const textureExists = scene.textures?.exists('hero-sprite');
        checks.push({name: 'Texture', status: textureExists ? 'pass' : 'fail', message: textureExists ? 'Hero texture exists' : 'Hero texture missing!'});
        
        let html = '<h4>Diagnostic Results:</h4>';
        checks.forEach(check => {
            const color = check.status === 'pass' ? '#10b981' : '#ef4444';
            const icon = check.status === 'pass' ? '‚úÖ' : '‚ùå';
            html += \`<p style="color:\${color};">\${icon} <strong>\${check.name}:</strong> \${check.message}</p>\`;
        });
        
        html += '<h4>Hero Details:</h4><pre style="font-size:11px;max-height:200px;overflow-y:auto;">';
        scene.partyMemberSprites?.forEach((pm, i) => {
            const sprite = pm.sprite;
            if (!sprite) {
                html += \`Hero \${i}: NO SPRITE\\n\`;
                return;
            }
            const tint = sprite.tintTopLeft || sprite.tint || 0;
            const tintHex = '0x' + tint.toString(16).padStart(6, '0').toUpperCase();
            html += \`Hero \${i} (\${pm.hero?.id || 'unknown'}):\\n\`;
            html += \`  Position: (\${sprite.x.toFixed(0)}, \${sprite.y.toFixed(0)})\\n\`;
            html += \`  Visible: \${sprite.visible}, Active: \${sprite.active}\\n\`;
            html += \`  Tint: \${tintHex}, Depth: \${sprite.depth}\\n\\n\`;
        });
        html += '</pre>';
        
        updateResults(html);
        console.log('=== Hero Visibility Diagnostic ===');
        checks.forEach(c => console.log(\`\${c.status === 'pass' ? '‚úÖ' : '‚ùå'} \${c.name}: \${c.message}\`));
    };
    panel.appendChild(diagnosticBtn);
    
    const forceBtn = document.createElement('button');
    forceBtn.textContent = 'üëÅÔ∏è Force All Visible';
    forceBtn.style.cssText = 'background:#10b981;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;margin:5px;display:block;width:100%;';
    forceBtn.onclick = () => {
        const scene = window.gameScene;
        if (!scene) return;
        let count = 0;
        scene.partyMemberSprites?.forEach((pm) => {
            if (pm.sprite) {
                pm.sprite.setVisible(true);
                pm.sprite.setActive(true);
                pm.sprite.setAlpha(1.0);
                count++;
            }
        });
        updateResults(\`<p style="color:#10b981;">‚úÖ Forced \${count} heroes visible!</p>\`);
        console.log(\`Forced \${count} heroes visible\`);
    };
    panel.appendChild(forceBtn);
    
    const logBtn = document.createElement('button');
    logBtn.textContent = 'üìã Log Hero States';
    logBtn.style.cssText = 'background:#8b5cf6;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;margin:5px;display:block;width:100%;';
    logBtn.onclick = () => {
        const scene = window.gameScene;
        if (!scene) return;
        console.log('=== Hero States ===');
        scene.partyMemberSprites?.forEach((pm, i) => {
            const sprite = pm.sprite;
            if (!sprite) {
                console.log(\`Hero \${i}: NO SPRITE\`);
                return;
            }
            const tint = sprite.tintTopLeft || sprite.tint || 0;
            const tintHex = '0x' + tint.toString(16).padStart(6, '0').toUpperCase();
            console.log(\`Hero \${i} (\${pm.hero?.id || 'unknown'}):\`, {
                position: { x: sprite.x, y: sprite.y },
                visible: sprite.visible,
                active: sprite.active,
                alpha: sprite.alpha,
                tint: tintHex,
                depth: sprite.depth,
                texture: sprite.texture?.key || 'N/A'
            });
        });
        updateResults('<p style="color:#3b82f6;">Hero states logged to console (F12)</p>');
    };
    panel.appendChild(logBtn);
    
    const cameraBtn = document.createElement('button');
    cameraBtn.textContent = 'üì∑ Check Camera Bounds';
    cameraBtn.style.cssText = 'background:#f59e0b;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;margin:5px;display:block;width:100%;';
    cameraBtn.onclick = () => {
        const scene = window.gameScene;
        if (!scene) return;
        const camera = scene.cameras?.main;
        if (!camera) {
            updateResults('<p style="color:#ef4444;">Camera not found!</p>');
            return;
        }
        const viewport = {
            left: camera.scrollX,
            right: camera.scrollX + camera.width,
            top: camera.scrollY,
            bottom: camera.scrollY + camera.height
        };
        let html = '<h4>Camera Viewport:</h4>';
        html += \`<p>Left: \${viewport.left.toFixed(0)}, Right: \${viewport.right.toFixed(0)}<br>Top: \${viewport.top.toFixed(0)}, Bottom: \${viewport.bottom.toFixed(0)}</p>\`;
        html += '<h4>Hero Positions:</h4><pre style="font-size:11px;">';
        scene.partyMemberSprites?.forEach((pm, i) => {
            const sprite = pm.sprite;
            if (!sprite) return;
            const inView = sprite.x >= viewport.left && sprite.x <= viewport.right && sprite.y >= viewport.top && sprite.y <= viewport.bottom;
            html += \`Hero \${i} (\${pm.hero?.id || 'unknown'}): \${inView ? '‚úì IN VIEW' : '‚úó OFF-SCREEN'}\\n\`;
            html += \`  Position: (\${sprite.x.toFixed(0)}, \${sprite.y.toFixed(0)})\\n\\n\`;
        });
        html += '</pre>';
        updateResults(html);
    };
    panel.appendChild(cameraBtn);
    
    const clearTintBtn = document.createElement('button');
    clearTintBtn.textContent = 'üé® Clear All Tints';
    clearTintBtn.style.cssText = 'background:#ec4899;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;margin:5px;display:block;width:100%;';
    clearTintBtn.onclick = () => {
        const scene = window.gameScene;
        if (!scene) return;
        let count = 0;
        scene.partyMemberSprites?.forEach((pm) => {
            if (pm.sprite) {
                pm.sprite.clearTint();
                count++;
            }
        });
        updateResults(\`<p style="color:#10b981;">‚úÖ Cleared tints from \${count} heroes!</p>\`);
    };
    panel.appendChild(clearTintBtn);
    
    document.body.appendChild(panel);
    setTimeout(() => diagnosticBtn.click(), 500);
    console.log('Hero Debug Panel injected!');
})();`;
        }
    </script>
</head>
<body style="background:#1e293b;color:white;padding:20px;font-family:system-ui;">
    <h1>Debugger Injection</h1>
    <p>This page will attempt to inject the debugger into the game window.</p>
</body>
</html>

